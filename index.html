<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTL35021 Certificate III in Dental Assisting Timetable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --dapa-primary: #532A8C;
            --dapa-secondary: #C3ACE8;
            --dapa-background: #F2F2F2;
            --dapa-accent-hover: #9D8ABB;
            --dapa-lilac-vibrant: #D1B3FF;
        }
        .bg-dapa-primary { background-color: var(--dapa-primary); }
        .text-dapa-primary { color: var(--dapa-primary); }
        .bg-dapa-secondary { background-color: var(--dapa-secondary); }
        .text-dapa-secondary { color: var(--dapa-secondary); }
        .bg-dapa-lilac { background-color: var(--dapa-lilac-vibrant); }
        .border-dapa-primary { border-color: var(--dapa-primary); }
        
        body { font-family: 'Inter', sans-serif; background-color: var(--dapa-background); }
        
        .sticky-unit {
            position: sticky;
            top: 0;
            z-index: 20;
            background: rgba(249, 250, 251, 0.95);
            backdrop-filter: blur(8px);
        }

        @keyframes pulse-soft {
            0% { box-shadow: 0 0 0 0 rgba(83, 42, 140, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(83, 42, 140, 0); }
            100% { box-shadow: 0 0 0 0 rgba(83, 42, 140, 0); }
        }
        .animate-pulse-prominent {
            animation: pulse-soft 2s infinite;
        }

        @media (max-width: 768px) {
            .desktop-table-header { display: none; }
            #table-body tr:not(.unit-row) { 
                display: block; 
                margin: 1rem; 
                border: 1px solid #edf2f7; 
                border-radius: 1rem; 
                background: white; 
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            }
            td { display: block; width: 100% !important; text-align: left !important; padding: 0.75rem 1rem !important; }
            .mobile-label { display: block; font-size: 10px; font-weight: 800; color: #a0aec0; text-transform: uppercase; margin-bottom: 0.25rem; }
            .unit-row { margin-top: 1rem; border: none; }
        }

        @media (min-width: 769px) {
            .mobile-label { display: none; }
        }

        @media print { 
            .no-print { display: none !important; }
            .sticky-unit { position: static; background: #f9fafb !important; }
            body { padding: 0; background: white; }
            .max-w-4xl { max-width: 100%; box-shadow: none; }
            #app-container { box-shadow: none; border: 1px solid #eee; }
        }
    </style>
</head>
<body class="min-h-screen py-10 px-4">

    <div class="max-w-4xl mx-auto">
        <div id="app-container" class="bg-white rounded-2xl shadow-xl overflow-hidden mb-8">
            
            <header class="bg-dapa-primary p-8 text-white relative">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 relative z-10">
                    <div>
                        <h1 class="text-4xl font-extrabold mb-1 tracking-tight">HTL35021</h1>
                        <p class="text-purple-200 text-sm uppercase font-semibold tracking-widest">Certificate III in Dental Assisting</p>
                    </div>
                    
                    <div class="bg-dapa-lilac p-5 rounded-xl border-4 border-white w-full md:w-72 shadow-lg">
                        <div class="space-y-3">
                            <div>
                                <label class="block text-[10px] uppercase font-black text-dapa-primary mb-1 ml-1">Student Name</label>
                                <input type="text" id="student-name" placeholder="Student Name" class="bg-white border border-gray-200 w-full text-sm font-bold text-gray-800 placeholder:text-gray-400 outline-none focus:ring-2 focus:ring-dapa-primary/20 focus:border-dapa-primary py-2 px-3 rounded-lg transition-all">
                            </div>
                            <div>
                                <label class="block text-[10px] uppercase font-black text-dapa-primary mb-1 ml-1">Student Number</label>
                                <input type="text" id="student-id" placeholder="Student Number" class="bg-white border border-gray-200 w-full text-sm font-bold text-gray-800 placeholder:text-gray-400 outline-none focus:ring-2 focus:ring-dapa-primary/20 focus:border-dapa-primary py-2 px-3 rounded-lg transition-all">
                            </div>
                        </div>
                    </div>
                    
                    <div class="hidden md:block">
                        <div class="h-16 w-32 bg-white/10 rounded-lg border border-white/20 flex items-center justify-center font-bold text-[10px] uppercase tracking-tighter italic text-center leading-none">DENTAL<br>ASSISTING</div>
                    </div>
                </div>
            </header>

            <section class="p-8 border-b border-gray-100 no-print">
                <div class="flex flex-col md:flex-row gap-8 items-end mb-2">
                    <div class="flex-grow w-full">
                        <label class="block text-xs font-bold text-dapa-primary mb-2 uppercase tracking-wide">TPP End Date</label>
                        <input type="date" id="input-end-date" class="w-full px-4 py-4 bg-gray-50 border-2 border-gray-200 rounded-xl outline-none focus:border-dapa-secondary transition-all text-lg font-semibold">
                    </div>
                    <div class="w-full md:w-auto">
                        <button id="btn-generate" disabled class="w-full bg-dapa-secondary text-dapa-primary font-black py-5 px-14 rounded-xl shadow-xl border-4 border-dapa-primary hover:scale-[1.05] active:scale-95 transition-all disabled:opacity-50 disabled:hover:scale-100 uppercase tracking-wider text-sm animate-pulse-prominent">
                            Generate Timetable
                        </button>
                    </div>
                </div>
                <!-- Data Load Status Indicator -->
                <div id="data-load-status" class="mt-4 text-center text-[10px] font-bold uppercase tracking-widest text-gray-400">
                    Initializing assessment data...
                </div>
            </section>

            <section id="dashboard" class="bg-gray-50 mt-4 px-8 pt-8 pb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Calculated Start</p>
                    <p id="stat-start-date" class="text-lg font-bold text-dapa-primary">--/--/--</p>
                </div>
                <div id="stat-pace-card" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Duration</p>
                    <p id="stat-pace" class="text-lg font-bold text-dapa-primary">N/A</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">End Date</p>
                    <p id="stat-end-date" class="text-lg font-bold text-dapa-primary">--/--/--</p>
                </div>
            </section>

            <section id="pace-info-box" class="px-8 pb-8 pt-4 hidden">
                <div id="pace-info-content" class="rounded-xl p-6 border-l-4 flex flex-col gap-3 shadow-sm bg-white">
                    <h4 id="pace-info-title" class="font-bold text-sm uppercase tracking-wide">Pace Analysis</h4>
                    <p id="pace-info-text" class="text-sm leading-relaxed text-gray-600 font-medium"></p>
                </div>
            </section>

            <div id="extension-alert" class="mx-8 mb-6 p-4 bg-amber-50 border-l-4 border-amber-500 hidden">
                <div class="flex items-start gap-3">
                    <div class="text-amber-500 pt-0.5">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-amber-800 uppercase tracking-tight">Timeline Alert: Accelerated Window</p>
                        <p class="text-sm text-amber-700 font-medium">Available time is less than 30 weeks. Your study dates have been compressed to fit this period.</p>
                    </div>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="desktop-table-header">
                        <tr class="bg-gray-100 text-dapa-primary text-sm uppercase font-extrabold tracking-tight">
                            <th class="p-4 w-1/4">Task</th>
                            <th class="p-4 w-1/2">Activity Description</th>
                            <th class="p-4 text-right">Last date of Submission</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="text-sm">
                        <tr><td colspan="3" class="p-12 text-center text-gray-400 italic font-medium">Enter a TPP End Date and student details to generate your roadmap.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <footer class="flex justify-between items-center no-print opacity-60 text-[10px] px-2 mb-10">
            <p>© 2025 Study Planner • NSW Public Holiday Logic Applied</p>
            <button onclick="window.print()" class="font-bold hover:underline uppercase tracking-tighter">Export as PDF</button>
        </footer>
    </div>

    <script>
        const TimetableEngine = {
            holidays: [
                '2025-01-01', '2025-01-27', '2025-04-18', '2025-04-19', '2025-04-20', '2025-04-21', 
                '2025-04-25', '2025-06-09', '2025-08-04', '2025-10-06', '2025-12-25', '2025-12-26',
                '2026-01-01', '2026-01-26', '2026-04-03', '2026-04-04', '2026-04-05', '2026-04-06',
                '2026-04-25', '2026-06-08', '2026-08-03', '2026-10-05', '2026-12-25', '2026-12-26'
            ],

            calculate: function(targetEndDate, studyData) {
                const today = new Date();
                today.setHours(0,0,0,0);
                const end = new Date(targetEndDate);
                end.setHours(23,59,59,999);

                const totalAvailableWorkingDays = this.countWorkingDays(today, end);
                const standardRequiredDays = studyData.reduce((acc, task) => acc + parseInt(task['Days Required']), 0);
                const scalingFactor = totalAvailableWorkingDays / standardRequiredDays;

                let currentDeadline = new Date(end);
                const schedule = [];

                for (let i = studyData.length - 1; i >= 0; i--) {
                    const task = studyData[i];
                    const deadline = new Date(currentDeadline);
                    const scaledDays = Math.max(1, Math.round(task['Days Required'] * scalingFactor));
                    
                    schedule.unshift({
                        code: task['Unit Code'],
                        unitDescription: task['Unit Description'],
                        assessment: task['Assessment'],
                        description: task['Assessment Description'],
                        deadline: deadline,
                        allocatedDays: scaledDays,
                        standardDays: parseInt(task['Days Required'])
                    });

                    currentDeadline = this.subtractWorkingDays(currentDeadline, scaledDays);
                }

                return {
                    startDate: today,
                    endDate: end,
                    schedule: schedule,
                    totalWeeks: Math.floor((end - today) / (1000 * 60 * 60 * 24 * 7)),
                    workingDaysRemaining: totalAvailableWorkingDays
                };
            },

            isWorkingDay: function(date) {
                const day = date.getDay();
                if (day === 0 || day === 6) return false;
                const dateStr = date.toISOString().split('T')[0];
                return !this.holidays.includes(dateStr);
            },

            subtractWorkingDays: function(date, days) {
                let result = new Date(date);
                let count = parseInt(days);
                while (count > 0) {
                    result.setDate(result.getDate() - 1);
                    if (this.isWorkingDay(result)) count--;
                }
                return result;
            },

            countWorkingDays: function(start, end) {
                if (end < start) return 0;
                let count = 0;
                let cur = new Date(start);
                while (cur <= end) {
                    if (this.isWorkingDay(cur)) count++;
                    cur.setDate(cur.getDate() + 1);
                }
                return count;
            },

            getPaceMetrics: function(weeks) {
                if (weeks >= 51) return { label: 'Flexible Pace', color: 'text-green-600', bg: 'bg-green-50', border: 'border-green-600', text: 'Excellent. You have ample time to manage your workload with a highly flexible study schedule.' };
                if (weeks >= 40) return { label: 'Normal Pace', color: 'text-dapa-primary', bg: 'bg-purple-50', border: 'border-dapa-primary', text: 'This is the ideal study intensity for professional outcomes and steady learning.' };
                if (weeks >= 30) return { label: 'Fast Track', color: 'text-orange-600', bg: 'bg-orange-50', border: 'border-orange-600', text: 'Your schedule is compressed. Dedicate consistent daily blocks to stay on track.' };
                return { label: 'Accelerated', color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-600', text: 'Highly demanding timeline. Review your capacity or consider a TPP extension if required.' };
            }
        };

        const DataLayer = {
            CSV_FILE_PATH: 'TIMETABLE_DATA.csv',
            timetableData: [],

            async loadTimetableData(statusEl, btnEl, tableBodyEl, onComplete) {
                try {
                    statusEl.textContent = `Loading assessment data from ${this.CSV_FILE_PATH}...`;
                    const response = await fetch(this.CSV_FILE_PATH);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const csvText = await response.text();
                    const parsedData = this.parseCSV(csvText);

                    if (parsedData.length > 0) {
                        this.timetableData = parsedData;
                        statusEl.textContent = `Successfully loaded ${parsedData.length} assessment tasks.`;
                        statusEl.classList.remove('text-gray-400');
                        statusEl.classList.add('text-green-600');
                        
                        // Callback for any post-load logic
                        if (onComplete) onComplete();
                    } else {
                        throw new Error("CSV file contains no valid assessment data.");
                    }
                } catch (error) {
                    console.error("Error loading CSV:", error);
                    statusEl.textContent = `Error loading data: ${error.message}.`;
                    statusEl.classList.remove('text-gray-400');
                    statusEl.classList.add('text-red-600');
                    tableBodyEl.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-red-500 font-bold uppercase text-xs">Error loading assessment data. Please check the CSV file.</td></tr>';
                }
            },

            parseCSV(csvText) {
                const lines = csvText.trim().split(/\r?\n/).filter(line => line.trim() !== "");
                if (lines.length < 2) return [];
                
                const headers = lines[0].split(',');
                return lines.slice(1).map(line => {
                    const row = [];
                    let currentField = '';
                    let inQuotes = false;
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') inQuotes = !inQuotes;
                        else if (char === ',' && !inQuotes) {
                            row.push(currentField.trim());
                            currentField = '';
                        } else currentField += char;
                    }
                    row.push(currentField.trim());
                    const obj = {};
                    headers.forEach((h, i) => { obj[h.trim()] = row[i] || ""; });
                    return obj;
                });
            }
        };

        const AppController = {
            init: function() {
                this.cacheDOM();
                this.bindEvents();
                
                // Load remote data first
                DataLayer.loadTimetableData(
                    this.dataStatus, 
                    this.btnGenerate, 
                    this.tableBody,
                    () => this.loadUserData() // Then load saved user state
                );
            },

            cacheDOM: function() {
                this.btnGenerate = document.getElementById('btn-generate');
                this.inputDate = document.getElementById('input-end-date');
                this.tableBody = document.getElementById('table-body');
                this.statStart = document.getElementById('stat-start-date');
                this.statEnd = document.getElementById('stat-end-date');
                this.statPace = document.getElementById('stat-pace');
                this.paceBox = document.getElementById('pace-info-box');
                this.paceTitle = document.getElementById('pace-info-title');
                this.paceText = document.getElementById('pace-info-text');
                this.paceContent = document.getElementById('pace-info-content');
                this.studentName = document.getElementById('student-name');
                this.studentId = document.getElementById('student-id');
                this.extensionAlert = document.getElementById('extension-alert');
                this.dataStatus = document.getElementById('data-load-status');
            },

            bindEvents: function() {
                this.inputDate.addEventListener('change', () => {
                    if (DataLayer.timetableData.length > 0) {
                        this.btnGenerate.disabled = !this.inputDate.value;
                    }
                });
                this.btnGenerate.addEventListener('click', () => this.handleGenerate());
                this.studentName.addEventListener('input', () => localStorage.setItem('dapa_name', this.studentName.value));
                this.studentId.addEventListener('input', () => localStorage.setItem('dapa_id', this.studentId.value));
            },

            loadUserData: function() {
                this.studentName.value = localStorage.getItem('dapa_name') || '';
                this.studentId.value = localStorage.getItem('dapa_id') || '';
                const savedDate = localStorage.getItem('dapa_target_date');
                if (savedDate) {
                    this.inputDate.value = savedDate;
                    if (DataLayer.timetableData.length > 0) {
                        this.btnGenerate.disabled = false;
                        this.handleGenerate();
                    }
                }
            },

            handleGenerate: function() {
                const targetDate = this.inputDate.value;
                if (!targetDate || DataLayer.timetableData.length === 0) return;

                localStorage.setItem('dapa_target_date', targetDate);
                const data = DataLayer.timetableData;
                const result = TimetableEngine.calculate(targetDate, data);

                if (result.totalWeeks < 30) this.extensionAlert.classList.remove('hidden');
                else this.extensionAlert.classList.add('hidden');

                this.updateUI(result);
            },

            updateUI: function(result) {
                const format = d => d.toLocaleDateString('en-AU');
                const pace = TimetableEngine.getPaceMetrics(result.totalWeeks);
                
                this.statStart.textContent = format(result.startDate);
                this.statEnd.textContent = format(result.endDate);
                this.statPace.textContent = `${pace.label} (${result.totalWeeks} Weeks)`;
                
                this.statStart.className = `text-lg font-bold text-dapa-primary`;
                this.statEnd.className = `text-lg font-bold text-dapa-primary`;
                this.statPace.className = `text-lg font-bold ${pace.color}`;

                this.paceBox.classList.remove('hidden');
                this.paceTitle.textContent = pace.label;
                this.paceTitle.className = `font-bold text-sm uppercase tracking-wide ${pace.color}`;
                this.paceText.textContent = pace.text;
                this.paceContent.className = `rounded-xl p-6 border-l-4 flex flex-col gap-3 shadow-sm ${pace.bg} ${pace.border}`;

                let lastUnitCode = null;
                let html = '';

                result.schedule.forEach((item) => {
                    if (item.code !== lastUnitCode) {
                        html += `
                            <tr class="sticky-unit unit-row shadow-sm">
                                <td colspan="3" class="p-4 border-y border-gray-100">
                                    <div class="flex items-center gap-3">
                                        <span class="text-dapa-primary font-extrabold text-sm uppercase tracking-tight bg-dapa-secondary/30 px-2 py-0.5 rounded w-max">${item.code}</span>
                                        <span class="text-dapa-primary font-bold text-sm leading-tight">${item.unitDescription}</span>
                                    </div>
                                </td>
                            </tr>
                        `;
                        lastUnitCode = item.code;
                    }

                    let paceLabel = "";
                    if (item.allocatedDays !== item.standardDays) {
                        const diffPercent = Math.round(Math.abs((item.allocatedDays - item.standardDays) / item.standardDays) * 100);
                        const state = item.allocatedDays > item.standardDays ? "more time" : "less time";
                        paceLabel = `(this is ${diffPercent}% ${state} than normal)`;
                    }

                    html += `
                        <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">
                            <td class="p-4 align-top">
                                <span class="mobile-label">Task</span>
                                <div class="font-bold text-gray-700 text-xs uppercase tracking-tighter leading-tight">${item.assessment}</div>
                            </td>
                            <td class="p-4 text-gray-600 text-sm align-top leading-relaxed">
                                <span class="mobile-label">Activity Description</span>
                                <div class="mb-1 font-medium text-gray-800">${item.description}</div>
                                <div class="text-[10px] font-bold italic ${pace.color} uppercase tracking-wide">
                                    Complete this in ${item.allocatedDays} days ${paceLabel}
                                </div>
                            </td>
                            <td class="p-4 text-right font-extrabold align-top whitespace-nowrap text-sm ${pace.color}">
                                <span class="mobile-label">Due Date</span>
                                ${format(item.deadline)}
                            </td>
                        </tr>
                    `;
                });

                this.tableBody.innerHTML = html;
            }
        };

        window.onload = () => AppController.init();
    </script>
</body>
</html>
