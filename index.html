<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLT35021 DAPA Assessment Timetable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --dapa-primary: #532A8C; 
            --dapa-secondary: #C3ACE8; 
            --dapa-background: #F2F2F2; 
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--dapa-background); }
        
        /* Highlight editable cells for the user */
        .editable-cell:hover { background-color: #f3f0ff; cursor: text; }
        .editable-cell:focus { outline: 2px solid var(--dapa-primary); background-color: white; }

        @media print {
            @page { size: A4 landscape; margin: 10mm; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background-color: white !important; padding: 0; }
            .max-w-6xl { max-width: none !important; width: 100% !important; box-shadow: none !important; margin: 0 !important; }
            thead { display: table-header-group !important; } /* Repeats headers */
            tr { page-break-inside: avoid !important; }
            th, td { border: 1px solid #ccc !important; padding: 8px !important; }
            th { background-color: #532A8C !important; color: white !important; -webkit-print-color-adjust: exact; }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-10">
        
        <header class="text-center mb-8 pb-4 border-b-2 border-[#532A8C]">
            <img src="dapa-logo.png" alt="DAPA Logo" class="mx-auto h-16 mb-4 object-contain" onerror="this.src='https://placehold.co/150x60?text=DAPA+LOGO'">
            <h1 class="no-print text-3xl font-extrabold text-[#532A8C]">HLT35021 DAPA Assessment Timetable</h1>
            <h1 class="print-only text-2xl font-bold text-[#532A8C]">Timetable for completion of written assessments for HLT35021 CERTIFICATE III IN DENTAL ASSISTING</h1>
        </header>

        <div class="print-only mb-8 p-6 border-2 rounded-lg border-[#532A8C]">
            <h2 class="text-xl font-bold text-[#532A8C] mb-6 text-center">Student Timetable Summary</h2>
            <div class="grid grid-cols-3 gap-8 text-center">
                <div><p class="text-xs font-bold uppercase text-gray-500">TPP End Date</p><p id="p-end" class="text-xl font-extrabold text-[#532A8C] mt-1">-</p></div>
                <div><p class="text-xs font-bold uppercase text-gray-500">Calculated Start Date</p><p id="p-start" class="text-xl font-extrabold text-[#532A8C] mt-1">-</p></div>
                <div><p class="text-xs font-bold uppercase text-gray-500">Remaining Time</p><p id="p-dur" class="text-xl font-extrabold text-[#532A8C] mt-1">-</p></div>
            </div>
        </div>

        <div class="no-print grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 p-6 bg-gray-50 rounded-lg border">
            <div><label class="block text-sm font-bold text-gray-700">Student Name</label><input type="text" id="s-name" class="w-full mt-1 p-2 border rounded"></div>
            <div><label class="block text-sm font-bold text-gray-700">Student Number</label><input type="text" id="s-num" class="w-full mt-1 p-2 border rounded"></div>
            <div><label class="block text-sm font-bold text-gray-700">TPP End Date</label><input type="date" id="s-date" class="w-full mt-1 p-2 border rounded border-[#532A8C]"></div>
            <div class="md:col-span-3">
                <button id="btn-gen" class="w-full bg-[#532A8C] text-white py-3 rounded-lg font-bold hover:bg-[#9D8ABB] transition disabled:opacity-50" disabled>Generate Timetable</button>
                <p id="load-msg" class="text-center text-xs mt-2 text-gray-500 font-medium">Checking for data file...</p>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-800">Submission Schedule</h2>
            <p class="no-print text-xs italic text-gray-400">Note: You can click any date to manually edit it.</p>
        </div>

        <div class="overflow-hidden rounded-lg border shadow-sm">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-[#532A8C]">
                    <tr>
                        <th class="w-1/6 px-4 py-3 text-left text-xs font-bold text-white uppercase">Task</th>
                        <th class="w-3/6 px-4 py-3 text-left text-xs font-bold text-white uppercase">Description</th>
                        <th class="w-2/6 px-4 py-3 text-center text-xs font-bold text-white uppercase">Submission Date</th>
                    </tr>
                </thead>
                <tbody id="t-body" class="bg-white divide-y divide-gray-200 text-sm">
                    <tr><td colspan="3" class="p-10 text-center text-gray-400">Please select a TPP End Date and click Generate.</td></tr>
                </tbody>
            </table>
        </div>

        <div class="no-print mt-8 flex justify-center">
            <button onclick="window.print()" class="bg-[#532A8C] text-white px-8 py-3 rounded-lg font-bold shadow-lg hover:bg-[#9D8ABB]">Print Timetable</button>
        </div>
    </div>

    <script>
        let taskData = [];
        const HOLIDAYS = ["2026-01-01", "2026-01-26", "2026-04-03", "2026-04-04", "2026-04-05", "2026-04-06", "2026-04-27", "2026-06-08", "2026-10-05", "2026-12-25", "2026-12-28"];

        const $ = (id) => document.getElementById(id);

        async function init() {
            try {
                const res = await fetch('TIMETABLE_DATA.csv');
                const text = await res.text();
                taskData = text.trim().split('\n').slice(1).map(row => {
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    return { unit: cols[0], desc: cols[1], task: cols[2], taskDesc: cols[3], days: parseInt(cols[4]) || 1 };
                });
                $('load-msg').textContent = "Data ready.";
                $('load-msg').classList.replace('text-gray-500', 'text-green-600');
            } catch (e) {
                $('load-msg').textContent = "CSV file not found. Ensure TIMETABLE_DATA.csv is present.";
                $('load-msg').classList.replace('text-gray-500', 'text-red-600');
            }
        }

        $('s-date').addEventListener('change', () => {
            $('btn-gen').disabled = !($('s-date').value && taskData.length > 0);
        });

        function isOff(d) {
            const s = d.toISOString().split('T')[0];
            return d.getDay() === 0 || d.getDay() === 6 || HOLIDAYS.includes(s);
        }

        function subtractDays(date, days) {
            let d = new Date(date);
            let count = 0;
            while (count < days) {
                d.setDate(d.getDate() - 1);
                if (!isOff(d)) count++;
            }
            return d;
        }

        function fmt(d) { return d.toLocaleDateString('en-GB'); }

        $('btn-gen').addEventListener('click', () => {
            const end = new Date($('s-date').value);
            let current = new Date(end);
            const schedule = [];
            
            // Calculate back from end date
            [...taskData].reverse().forEach(t => {
                const subDate = new Date(current);
                schedule.push({ ...t, subDate });
                current = subtractDays(subDate, t.days);
            });

            // Update Summaries
            const start = schedule[schedule.length - 1].subDate;
            const diff = Math.ceil((end - start) / (1000 * 60 * 60 * 24 * 7));
            
            $('p-end').textContent = fmt(end);
            $('p-start').textContent = fmt(current);
            $('p-dur').textContent = diff + " Weeks";

            // Build Table
            const body = $('t-body');
            body.innerHTML = '';
            let lastU = '';

            schedule.reverse().forEach(t => {
                if (t.unit !== lastU) {
                    const h = body.insertRow();
                    h.className = "bg-gray-50 font-bold text-[#532A8C]";
                    h.innerHTML = `<td colspan="3" class="px-4 py-2 border-t border-b">${t.unit}: ${t.desc}</td>`;
                }
                const r = body.insertRow();
                r.innerHTML = `
                    <td class="px-4 py-3 text-gray-600 font-medium">${t.task}</td>
                    <td class="px-4 py-3 text-gray-500">${t.taskDesc}</td>
                    <td class="px-4 py-3 text-center font-bold text-[#532A8C] editable-cell" contenteditable="true">${fmt(t.subDate)}</td>
                `;
                lastU = t.unit;
            });
        });

        window.onload = init;
    </script>
</body>
</html>
