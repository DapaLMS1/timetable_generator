<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTL35021 Certificate III in Dental Assisting Timetable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --dapa-primary: #532A8C;
            --dapa-secondary: #C3ACE8;
            --dapa-background: #F2F2F2;
            --dapa-accent-hover: #9D8ABB;
            --dapa-lilac-vibrant: #D1B3FF;
        }
        .bg-dapa-primary { background-color: var(--dapa-primary); }
        .text-dapa-primary { color: var(--dapa-primary); }
        .bg-dapa-secondary { background-color: var(--dapa-secondary); }
        .text-dapa-secondary { color: var(--dapa-secondary); }
        .bg-dapa-lilac { background-color: var(--dapa-lilac-vibrant); }
        .border-dapa-primary { border-color: var(--dapa-primary); }
        
        body { font-family: 'Inter', sans-serif; background-color: var(--dapa-background); }
        
        @media (max-width: 768px) {
            .desktop-table-header { display: none; }
            #table-body tr { 
                display: block; 
                margin: 1rem; 
                border: 1px solid #edf2f7; 
                border-radius: 1rem; 
                background: white; 
            }
            td { display: block; width: 100% !important; padding: 0.75rem 1rem !important; }
        }
    </style>
</head>
<body class="min-h-screen py-10 px-4">

    <div class="max-w-4xl mx-auto">
        <!-- OAuth Connectivity Banner -->
        <div id="auth-banner" class="mb-4">
            <div class="bg-white border border-gray-200 rounded-xl p-3 flex justify-between items-center shadow-sm">
                <div class="flex items-center gap-3">
                    <div id="auth-indicator" class="w-2 h-2 rounded-full bg-red-500"></div>
                    <span class="text-xs font-bold text-gray-600 uppercase tracking-tight" id="auth-user-label">ReadyTech Disconnected</span>
                </div>
                <button id="btn-auth-action" class="text-[10px] font-black uppercase bg-dapa-primary text-white px-4 py-1.5 rounded-lg hover:opacity-90 transition-all">
                    Connect ReadyTech
                </button>
            </div>
        </div>

        <div id="app-container" class="bg-white rounded-2xl shadow-xl overflow-hidden mb-8">
            <header class="bg-dapa-primary p-8 text-white">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                    <div>
                        <h1 class="text-4xl font-extrabold mb-1 tracking-tight">HTL35021</h1>
                        <p class="text-purple-200 text-sm uppercase font-semibold tracking-widest">Certificate III in Dental Assisting</p>
                    </div>
                    
                    <div class="bg-dapa-lilac p-5 rounded-xl border-4 border-white w-full md:w-80 shadow-lg">
                        <div class="space-y-3">
                            <div>
                                <label class="block text-[10px] uppercase font-black text-dapa-primary mb-1 ml-1">Student Number</label>
                                <div class="flex gap-2">
                                    <input type="text" id="student-id" placeholder="e.g. 00020000" class="bg-white border border-gray-200 flex-grow text-sm font-bold text-gray-800 py-2 px-3 rounded-lg outline-none">
                                    <button id="btn-verify" class="bg-dapa-primary text-white text-[10px] px-3 py-2 rounded-lg font-bold uppercase tracking-tight">Sync</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-[10px] uppercase font-black text-dapa-primary mb-1 ml-1">Student Name</label>
                                <input type="text" id="student-name" placeholder="Waiting for sync..." class="bg-white border border-gray-200 w-full text-sm font-bold text-gray-800 py-2 px-3 rounded-lg outline-none" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <section class="p-8 border-b border-gray-100">
                <div class="flex flex-col md:flex-row gap-8 items-end mb-2">
                    <div class="flex-grow w-full">
                        <label class="block text-xs font-bold text-dapa-primary mb-2 uppercase tracking-wide">Course End Date</label>
                        <input type="date" id="input-end-date" class="w-full px-4 py-4 bg-gray-50 border-2 border-gray-200 rounded-xl outline-none focus:border-dapa-secondary transition-all text-lg font-semibold">
                    </div>
                    <div class="w-full md:w-auto">
                        <button id="btn-generate" disabled class="w-full bg-dapa-secondary text-dapa-primary font-black py-5 px-14 rounded-xl shadow-xl border-4 border-dapa-primary uppercase tracking-wider text-sm disabled:opacity-50">
                            Generate
                        </button>
                    </div>
                </div>
                <div id="data-load-status" class="mt-4 text-center text-[10px] font-bold uppercase tracking-widest text-gray-400 italic">
                    Ready to Connect
                </div>
            </section>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="desktop-table-header">
                        <tr class="bg-gray-100 text-dapa-primary text-sm uppercase font-extrabold tracking-tight">
                            <th class="p-4 w-1/4">Task</th>
                            <th class="p-4 w-1/2">Activity Description</th>
                            <th class="p-4 text-right">Submission Date</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="text-sm">
                        <tr><td colspan="3" class="p-12 text-center text-gray-400 italic">Please connect and sync your student profile.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        /**
         * UPDATED OAUTH CONFIGURATION FROM JOBREADY DOCUMENTATION
         */
        const OAuthConfig = {
            clientId: '64a08b7b43b1b59e38d6cd924ff34110539caf9e006e1c336ff7d7b464b355d4', 
            clientSecret: '7f1d4209162ae8b75f4ac500cca90ab8747e842e76cd0c00138b9fbb0bc06d83',
            // Corrected to use the tenant-specific subdomain as per standard JobReady multi-tenant setups
            authUrl: 'https://dapa.jobreadyplus.com/connect/authorize',
            tokenUrl: 'https://dapa.jobreadyplus.com/connect/token',
            redirectUri: 'https://dapalms1.github.io/timetable_generator/index.html',
            scope: 'jobreadyplus.readonly openid profile'
        };

        const OAuthManager = {
            async startLogin() {
                const verifier = this.generateRandomString(64);
                localStorage.setItem('rt_verifier', verifier);
                
                const challenge = await this.generateChallenge(verifier);
                
                // Using dapa.jobreadyplus.com ensures the context is already set to your tenant
                const url = `${OAuthConfig.authUrl}?` +
                    `client_id=${OAuthConfig.clientId}&` +
                    `redirect_uri=${encodeURIComponent(OAuthConfig.redirectUri)}&` +
                    `response_type=code&` +
                    `scope=${encodeURIComponent(OAuthConfig.scope)}&` +
                    `code_challenge=${challenge}&` +
                    `code_challenge_method=S256&` +
                    `acr_values=${encodeURIComponent('tenant:dapa')}`;
                
                window.location.href = url;
            },

            async exchangeCode(code) {
                const verifier = localStorage.getItem('rt_verifier');
                const params = new URLSearchParams();
                params.append('grant_type', 'authorization_code');
                params.append('client_id', OAuthConfig.clientId);
                params.append('client_secret', OAuthConfig.clientSecret);
                params.append('code', code);
                params.append('redirect_uri', OAuthConfig.redirectUri);
                params.append('code_verifier', verifier);

                try {
                    const response = await fetch(OAuthConfig.tokenUrl, {
                        method: 'POST',
                        body: params,
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        return { success: false, error: errorData.error_description || `HTTP ${response.status}` };
                    }

                    const data = await response.json();
                    if (data.access_token) {
                        localStorage.setItem('rt_token', data.access_token);
                        return { success: true };
                    } else {
                        return { success: false, error: data.error_description || data.error || 'Unknown error' };
                    }
                } catch (e) {
                    return { success: false, error: "Network Error: Could not reach Identity Server." };
                }
            },

            generateRandomString(length) {
                const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let text = '';
                for (let i = 0; i < length; i++) {
                    text += possible.charAt(Math.floor(Math.random() * possible.length));
                }
                return text;
            },

            async generateChallenge(verifier) {
                const encoder = new TextEncoder();
                const data = encoder.encode(verifier);
                const hash = await window.crypto.subtle.digest('SHA-256', data);
                return btoa(String.fromCharCode(...new Uint8Array(hash)))
                    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            }
        };

        const App = {
            async init() {
                this.cache();
                this.bind();
                await this.checkCallback();
                this.refreshUI();
            },

            cache() {
                this.btnAuth = document.getElementById('btn-auth-action');
                this.authLabel = document.getElementById('auth-user-label');
                this.authDot = document.getElementById('auth-indicator');
                this.btnSync = document.getElementById('btn-verify');
                this.btnGen = document.getElementById('btn-generate');
                this.inId = document.getElementById('student-id');
                this.inName = document.getElementById('student-name');
                this.inDate = document.getElementById('input-end-date');
                this.status = document.getElementById('data-load-status');
            },

            bind() {
                this.btnAuth.onclick = () => {
                    if (localStorage.getItem('rt_token')) {
                        localStorage.clear();
                        location.reload();
                    } else {
                        OAuthManager.startLogin();
                    }
                };
                this.btnSync.onclick = () => this.syncProfile();
            },

            async checkCallback() {
                const params = new URLSearchParams(window.location.search);
                const code = params.get('code');
                if (code) {
                    this.status.textContent = "Validating secure session...";
                    const result = await OAuthManager.exchangeCode(code);
                    window.history.replaceState({}, document.title, window.location.pathname);
                    if (result.success) location.reload();
                    else this.status.textContent = "Auth Error: " + result.error;
                }
            },

            refreshUI() {
                const token = localStorage.getItem('rt_token');
                if (token) {
                    this.authDot.classList.replace('bg-red-500', 'bg-green-500');
                    this.authLabel.textContent = "ReadyTech Active";
                    this.btnAuth.textContent = "Logout";
                }
            },

            async syncProfile() {
                const id = this.inId.value.trim();
                const token = localStorage.getItem('rt_token');
                if (!token) return;

                this.status.textContent = "Syncing with ReadyStudent...";
                try {
                    // API remains on the centralized jobreadyplus domain or follow tenant subdomain
                    const url = `https://api.jobreadyplus.com/v1/students/${id}`;
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                    
                    const response = await fetch(proxyUrl, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const wrapper = await response.json();
                    if (!wrapper.contents) throw new Error("No data returned.");

                    const student = JSON.parse(wrapper.contents);
                    if (student.firstName) {
                        this.inName.value = `${student.firstName} ${student.lastName}`;
                        this.status.textContent = "Student Sync Successful";
                        this.btnGen.disabled = false;
                    } else {
                        throw new Error("Student not found.");
                    }
                } catch (e) {
                    this.status.textContent = "Sync Failed: Check credentials or Student ID.";
                }
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
