<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLT35021 DAPA Assessment Timetable</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Define DAPA Color Palette */
        :root {
            --dapa-primary: #532A8C; /* Deep Purple (Main Text, Accent) */
            --dapa-secondary: #C3ACE8; /* Light Purple/Lavender (Buttons, Highlights) */
            --dapa-background: #F2F2F2; /* Very Light Grey (Body Background) */
            --dapa-accent-hover: #9D8ABB; /* Muted Medium Purple (Hover State) */
        }
        /* Custom styles to incorporate DAPA colors via Tailwind theme */
        .bg-dapa-primary { background-color: var(--dapa-primary); }
        .text-dapa-primary { color: var(--dapa-primary); }
        .bg-dapa-secondary { background-color: var(--dapa-secondary); }
        .text-dapa-secondary { color: var(--dapa-secondary); }
        .bg-dapa-background { background-color: var(--dapa-background); }
        .hover\:bg-dapa-accent-hover:hover { background-color: var(--dapa-accent-hover); }
        
        /* Apply Inter font globally and ensure rounded corners */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dapa-background);
        }

        /* Responsive table styling */
        .table-container {
            overflow-x: auto;
        }

        /* Print styles */
        @media print {
            body {
                background-color: white !important;
            }
            .no-print {
                display: none !important;
            }
            .table-container {
                overflow-x: visible;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th, td {
                border: 1px solid #ccc;
                padding: 8px;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8 no-print">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-dapa-primary mb-2">
                HLT35021
            </h1>
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-700">
                DAPA Assessment Timetable
            </h2>
            <p class="text-sm text-gray-500 mt-2">
                Last Updated: <span id="last-updated">N/A</span>
            </p>
        </header>

        <!-- Timetable Card -->
        <div class="bg-white shadow-xl rounded-xl overflow-hidden p-4 sm:p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Assessment Due Dates</h3>
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-dapa-secondary/50">
                        <tr>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-1/4 sm:w-1/5">
                                Assessment
                            </th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-1/4 sm:w-1/5">
                                Due Date
                            </th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-1/2 sm:w-3/5">
                                Remaining Time
                            </th>
                        </tr>
                    </thead>
                    <tbody id="timetable-body" class="bg-white divide-y divide-gray-200">
                        <!-- Timetable rows will be rendered here by JavaScript -->
                        <tr>
                            <td colspan="3" class="p-8 text-center text-gray-500">Loading Timetable Data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex justify-center mt-6 no-print" id="print-button-container">
            <button id="print-button" class="bg-dapa-primary text-white py-2 px-6 rounded-lg font-semibold hover:bg-dapa-accent-hover transition duration-150 shadow-md flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
                    <path fill-rule="evenodd" d="M5 2.5A1.5 1.5 0 0 1 6.5 1h7A1.5 1.5 0 0 1 15 2.5v12.5a1.5 1.5 0 0 1-1.5 1.5h-7A1.5 1.5 0 0 1 5 15V2.5ZM15 5.5v2.5a.75.75 0 0 0 1.5 0V4a1 1 0 0 0-1-1h-3a.75.75 0 0 0 0 1.5h2.5ZM5 4a1 1 0 0 0-1 1v3.5a.75.75 0 0 0 1.5 0V5.5H8a.75.75 0 0 0 0-1.5H5Z" clip-rule="evenodd" />
                </svg>
                Print Timetable
            </button>
        </div>
    </div>

    <script type="module">
        // Global variables for Firebase setup
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isAuthReady = false;

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, orderBy, where, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable debug logging for Firestore
        setLogLevel('debug');

        /**
         * The single source of truth for the assessment data.
         * The 'due' field should be in YYYY-MM-DD format.
         */
        const initialAssessments = [
            { id: '1', name: 'Assessment 1', due: '2025-12-05' },
            { id: '2', name: 'Assessment 2', due: '2025-12-19' },
            { id: '3', name: 'Assessment 3', due: '2026-01-09' },
            { id: '4', name: 'Assessment 4', due: '2026-01-23' },
            { id: '5', name: 'Assessment 5', due: '2026-02-06' },
            { id: '6', name: 'Assessment 6', due: '2026-02-20' },
        ];

        // --- Utility Functions ---

        /**
         * Calculates the remaining time until the due date, displaying only whole weeks
         * if the time remaining is more than 7 days, or days if 7 days or less.
         * @param {string} dueDate - The due date in YYYY-MM-DD format.
         * @returns {string} HTML span with the formatted remaining time.
         */
        function calculateRemainingTime(dueDate) {
            const now = new Date();
            // Due date is at the beginning of the day (00:00:00). We calculate remaining time
            // until the end of that day (23:59:59) to be inclusive.
            const due = new Date(dueDate);
            due.setHours(23, 59, 59, 999); 

            // Calculate difference in milliseconds
            const diffTime = due - now;

            if (diffTime < 0) {
                return '<span class="font-bold text-red-600">OVERDUE</span>';
            }

            // Calculate total remaining days (rounding up to ensure today counts as a full day if due tomorrow)
            const totalDaysRemaining = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (totalDaysRemaining <= 7) {
                // For clarity when time is very close, we show days
                return `<span class="font-semibold text-orange-500">${totalDaysRemaining} ${totalDaysRemaining === 1 ? 'day' : 'days'}</span>`;
            }

            // Calculate ONLY whole weeks remaining, discarding leftover days
            const remainingWeeks = Math.floor(totalDaysRemaining / 7);

            const weekString = `${remainingWeeks} ${remainingWeeks === 1 ? 'week' : 'weeks'}`;

            return `<span class="font-semibold">${weekString}</span>`;
        }

        /**
         * Renders the assessment timetable rows.
         * @param {Array<Object>} assessments - List of assessment objects.
         */
        function renderTimetable(assessments) {
            const tableBody = document.getElementById('timetable-body');
            if (!tableBody) return;

            // Sort by due date
            assessments.sort((a, b) => new Date(a.due) - new Date(b.due));

            const rowsHtml = assessments.map(item => {
                const formattedDate = new Date(item.due).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                });
                const remainingTimeHtml = calculateRemainingTime(item.due);

                return `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${formattedDate}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${remainingTimeHtml}</td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = rowsHtml || `
                <tr>
                    <td colspan="3" class="p-8 text-center text-gray-500">No assessment data found.</td>
                </tr>
            `;

            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        }

        // --- Firebase/Data Management ---

        /**
         * Initializes Firebase and sets up the auth listener.
         */
        async function initializeAppAndAuth() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing. Using local data only.");
                renderTimetable(initialAssessments);
                isAuthReady = true;
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Set up auth state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated with UID:", userId);
                    } else {
                        // Sign in anonymously if no token is available
                        if (!initialAuthToken) {
                            await signInAnonymously(auth);
                        }
                    }
                    isAuthReady = true;
                    // Once authenticated (or anonymously signed in), start listening for data
                    listenForAssessmentData();
                });

                // Use custom token if provided
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }
            } catch (error) {
                console.error("Firebase Initialization or Auth Failed:", error);
                // Fallback to local data if Firebase fails
                renderTimetable(initialAssessments);
                isAuthReady = true;
            }
        }

        /**
         * Sets up the real-time listener for assessment data from Firestore.
         */
        function listenForAssessmentData() {
            // Only proceed if auth is ready and Firestore is initialized
            if (!isAuthReady || !db) {
                // Use initial data as a fallback if Firebase is not ready
                renderTimetable(initialAssessments);
                return; 
            }
            
            // Public collection path: /artifacts/{appId}/public/data/assessments
            const collectionPath = `artifacts/${appId}/public/data/assessments`;
            const assessmentsRef = collection(db, collectionPath);
            
            // We cannot use orderBy('due', 'asc') because Firestore requires an index, 
            // which we cannot guarantee is present. We will fetch all and sort in memory.
            const q = query(assessmentsRef);

            // Set up real-time listener
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const firestoreAssessments = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Merge initial data with Firestore data (Firestore overrides initial data if IDs match)
                const mergedAssessments = [...initialAssessments];
                firestoreAssessments.forEach(fsItem => {
                    const index = mergedAssessments.findIndex(item => item.id === fsItem.id);
                    if (index !== -1) {
                        mergedAssessments[index] = fsItem; // Update existing
                    } else {
                        mergedAssessments.push(fsItem); // Add new
                    }
                });

                renderTimetable(mergedAssessments);
            }, (error) => {
                console.error("Error fetching assessment data:", error);
                // Display initial data on error
                renderTimetable(initialAssessments);
            });

            // Note: In a full app, you might want to return 'unsubscribe' to clean up.
        }

        // --- Event Listeners and Initial Load ---

        document.addEventListener('DOMContentLoaded', () => {
            initializeAppAndAuth();

            // Print button handler
            document.getElementById('print-button').addEventListener('click', () => {
                window.print();
            });
        });

    </script>
</body>
</html>
