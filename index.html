<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLT35021 DAPA Assessment Timetable</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Define DAPA Color Palette */
        :root {
            --dapa-primary: #532A8C; /* Deep Purple (Main Text, Accent) */
            --dapa-secondary: #C3ACE8; /* Light Purple/Lavender (Buttons, Highlights) */
            --dapa-background: #F2F2F2; /* Very Light Grey (Body Background) */
            --dapa-accent-hover: #9D8ABB; /* Muted Medium Purple (Hover State) */
        }
        /* Custom styles to incorporate DAPA colors via Tailwind theme */
        .bg-dapa-primary { background-color: var(--dapa-primary); }
        .text-dapa-primary { color: var(--dapa-primary); }
        .bg-dapa-secondary { background-color: var(--dapa-secondary); }
        .text-dapa-secondary { color: var(--dapa-secondary); }
        .bg-dapa-background { background-color: var(--dapa-background); }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dapa-background);
        }
        .timetable-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header-section {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border-top: 5px solid var(--dapa-primary);
        }
        /* Row animations and styling */
        .timetable-row {
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .timetable-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        /* Message Box Styling */
        #message-box {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 50;
        }

        /* --- Print Styles --- */
        @media print {
            body {
                background-color: white !important; /* White background for print */
                margin: 0;
                padding: 0;
            }
            .timetable-container {
                max-width: none; /* Use full width */
                margin: 0;
                padding: 1cm;
            }
            /* Hide elements not needed in the printed document */
            .header-section, 
            #student-details-form, 
            #print-button-container, 
            .no-print {
                display: none !important;
            }
            /* Show the dedicated print info block */
            #print-info {
                display: block !important;
                margin-bottom: 1.5rem;
                padding-bottom: 0.5rem;
                border-bottom: 1px solid #ccc;
            }
            /* Ensure table structure is preserved */
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th, td {
                border: 1px solid #e5e7eb;
                padding: 0.5rem;
            }
            /* Ensure colors print (if browser is set to print background graphics) */
            .bg-dapa-primary {
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                background-color: var(--dapa-primary) !important;
                color: white !important;
            }
            .text-dapa-primary {
                color: var(--dapa-primary) !important;
            }
            /* Remove hover effects */
            .timetable-row:hover {
                transform: none;
                box-shadow: none;
            }
        }
        /* --- End Print Styles --- */
    </style>
    <!-- Firebase Libraries -->
    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        
        // =========================================================================
        // --- CUSTOM CONFIGURATION FOR LOCAL RUNNING (To fix "Configuration missing") ---
        // These placeholders allow the app to run outside the canvas environment.
        // NOTE: Saving/Loading will fail with this dummy config unless replaced.
        // =========================================================================
        const DUMMY_FIREBASE_CONFIG = {
            apiKey: "DUMMY_API_KEY",
            authDomain: "DUMMY_PROJECT_ID.firebaseapp.com",
            projectId: "DUMMY_PROJECT_ID",
            storageBucket: "DUMMY_PROJECT_ID.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:DUMMY_WEB_APP_ID"
        };
        
        // Global variables provided by the Canvas environment (with local fallbacks)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : DUMMY_FIREBASE_CONFIG;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db;
        let auth;
        let userId = null;
        let isSavingEnabled = true;

        // Normalize Today's Date to midday for clean comparison (to avoid timezone issues at midnight)
        const TODAY = (() => {
            const d = new Date();
            // Set time to noon for comparison purposes
            d.setHours(12, 0, 0, 0); 
            return d;
        })();

        // --- Data Source for Assessments ---
        const UNIT_ASSESSMENT_DATA = [
            { UnitCode: 'INTRO', UnitDescription: "Let's get started!", AssessmentName: 'Task 1', AssessmentDescription: 'Introduction (Mandatory)', Weeks: '0 week' },
            { UnitCode: 'CHCCOM005', UnitDescription: 'Communicate and work in health or community service', AssessmentName: 'Task 1', AssessmentDescription: 'The Dental Health Team', Weeks: '1 week' },
            { UnitCode: 'CHCCOM005', UnitDescription: 'Communicate and work in health or community service', AssessmentName: 'Task 2', AssessmentDescription: 'Ethics and Jurisprudence', Weeks: '1 week' },
            { UnitCode: 'CHCCOM005', UnitDescription: 'Communicate and work in health or community service', AssessmentName: 'Task 3', AssessmentDescription: 'Psychology for Dental Assistants', Weeks: '0 week' },
            { UnitCode: 'CHCDIV001', UnitDescription: 'Work with diverse people', AssessmentName: 'Task 4', AssessmentDescription: 'Demonstrate understanding of diversity, culture, and inclusive practice.', Weeks: '1 week' },
            { UnitCode: 'CHCDIV001', UnitDescription: 'Work with diverse people', AssessmentName: 'Task 5', AssessmentDescription: 'Apply inclusive and respectful communication and work practices.', Weeks: '1 week' },
            { UnitCode: 'HLTWHS001', UnitDescription: 'Participate in workplace health and safety', AssessmentName: 'Task 1', AssessmentDescription: 'Demonstrate essential WHS knowledge', Weeks: '1 week' },
            { UnitCode: 'HLTWHS001', UnitDescription: 'Participate in workplace health and safety', AssessmentName: 'Task 2', AssessmentDescription: 'Identify, assess, and control hazards', Weeks: '0 week' },
            { UnitCode: 'HLTWHS001', UnitDescription: 'Participate in workplace health and safety', AssessmentName: 'Task 3', AssessmentDescription: 'Participate in WHS activities and follow emergency procedures', Weeks: '1 week' },
            { UnitCode: 'HLTINF006', UnitDescription: 'Apply basic principles and practices of infection prevention and control', AssessmentName: 'Task 1', AssessmentDescription: 'Demonstrate understanding of infection control principles', Weeks: '1 week' },
            { UnitCode: 'HLTINF006', UnitDescription: 'Apply basic principles and practices of infection prevention and control', AssessmentName: 'Task 2', AssessmentDescription: 'Identify infection risks and select/use Personal Protective Equipment (PPE)', Weeks: '1 week' },
            { UnitCode: 'HLTINF006', UnitDescription: 'Apply basic principles and practices of infection prevention and control', AssessmentName: 'Task 3', AssessmentDescription: 'Apply standard infection control procedures, including reprocessing reusable equipment.', Weeks: '2 weeks' },
            { UnitCode: 'HLTINF006', UnitDescription: 'Apply basic principles and practices of infection prevention and control', AssessmentName: 'Task 4', AssessmentDescription: 'Final assessment for Infection Control', Weeks: '0 week' },
            
            // --- HLTINF002 ---
            { UnitCode: 'HLTINF002', UnitDescription: 'Process reusable instruments and equipment in health work', AssessmentName: 'Task 5', AssessmentDescription: 'Drying, Inspection, and Packaging', Weeks: '1 week' },
            { UnitCode: 'HLTINF002', UnitDescription: 'Process reusable instruments and equipment in health work', AssessmentName: 'Task 6', AssessmentDescription: 'Operating the Steriliser (Autoclave)', Weeks: '0 week' },
            // --- END HLTINF002 ---
            
            { UnitCode: 'HLTDEN015', UnitDescription: 'Prepare for and assist with dental procedures', AssessmentName: 'Workbook 1', AssessmentDescription: 'Foundational Clinic & Communication', Weeks: '5 weeks' },
            { UnitCode: 'HLTDEN015', UnitDescription: 'Prepare for and assist with dental procedures', AssessmentName: 'Workbook 2', AssessmentDescription: 'Clinical Assistance & Logistics', Weeks: '3 weeks' },
            { UnitCode: 'HLTDEN015', UnitDescription: 'Prepare for and assist with dental procedures', AssessmentName: 'Workbook 3', AssessmentDescription: 'Theoretical Knowledge (Anatomy, Pathology, Pharmacology)', Weeks: '3 weeks' },
            { UnitCode: 'HLTDEN015', UnitDescription: 'Prepare for and assist with dental procedures', AssessmentName: 'Workbook 4', AssessmentDescription: 'Specialised Fields & Patient Groups', Weeks: '3 weeks' },
            { UnitCode: 'HLTDEN016', UnitDescription: 'Assist with dental radiography', AssessmentName: 'Task 1', AssessmentDescription: 'Demonstrate knowledge of radiation safety, equipment, and protocols', Weeks: '1 week' },
            { UnitCode: 'HLTDEN016', UnitCode: 'Assist with dental radiography', AssessmentName: 'Task 2', AssessmentDescription: 'Prepare the surgery, patient, and equipment for X-ray procedures', Weeks: '0 week' },
            { UnitCode: 'HLTDEN016', UnitDescription: 'Assist with dental radiography', AssessmentName: 'Task 3', AssessmentDescription: 'Correctly process and mount conventional/digital radiographs', Weeks: '1 week' },
            { UnitCode: 'HLTDEN016', UnitDescription: 'Assist with dental radiography', AssessmentName: 'Task 4', AssessmentDescription: 'Complete documentation and comply with quality assurance', Weeks: '0 week' },
            { UnitCode: 'HLTDEN017', UnitDescription: 'Assist with administration in dental practice', AssessmentName: 'Task 1', AssessmentDescription: 'Communicate appropriately in a dental administrative setting', Weeks: '1 week' },
            { UnitCode: 'HLTDEN017', UnitDescription: 'Assist with administration in dental practice', AssessmentName: 'Task 2', AssessmentDescription: 'Allocate appointments appropriate to patient and organisation requirements', Weeks: '0 week' },
            { UnitCode: 'HLTDEN017', UnitDescription: 'Assist with administration in dental practice', AssessmentName: 'Task 3', AssessmentDescription: 'Process and reconcile patient accounts', Weeks: '1 week' },
            { UnitCode: 'HLTDEN017', UnitDescription: 'Assist with administration in dental practice', AssessmentName: 'Task 4', AssessmentDescription: 'Maintain patient records', Weeks: '0 week' },
            { UnitCode: 'HLTDEN017', UnitDescription: 'Assist with patient recalls', AssessmentName: 'Task 5', AssessmentDescription: 'Assist with patient recalls', Weeks: '1 week' },
            { UnitCode: 'BSBTEC201', UnitDescription: 'Use business software applications', AssessmentName: 'Task 1', AssessmentDescription: 'Knowledge questions', Weeks: '1 week' },
            { UnitCode: 'BSBTEC201', UnitDescription: 'Use business software applications', AssessmentName: 'Task 2', AssessmentDescription: 'Word processing', Weeks: '1 week' },
            { UnitCode: 'BSBTEC201', UnitDescription: 'Use business software applications', AssessmentName: 'Task 3', AssessmentDescription: 'Spreadsheets', Weeks: '1 week' },
            { UnitCode: 'BSBTWK201', UnitDescription: 'Work effectively with others', AssessmentName: 'Task 1', AssessmentDescription: 'Knowledge questions', Weeks: '1 week' },
            // Corrected AssessmentName/AssessmentDescription mapping
            { UnitCode: 'BSBTWK201', UnitDescription: 'Work effectively with others', AssessmentName: 'Task 2', AssessmentDescription: 'Reflective journal', Weeks: '1 week' },
            
            // HLTAID011 MOVED TO END
            { UnitCode: 'HLTAID011', UnitDescription: 'Provide First Aid', AssessmentName: 'Task 1', AssessmentDescription: 'Provide First Aid (Practical/Knowledge)', Weeks: '1 week' },
            { UnitCode: 'HLTAID011', UnitDescription: 'Provide First Aid', AssessmentName: 'Task 2', AssessmentDescription: 'First Aid in the Dental Setting', Weeks: '0 week' },
        ];

        // --- Representative Public Holidays (NSW 2026 - YYYY-MM-DD) ---
        // NOTE: This array should be dynamically updated for the current year in a real deployment
        const PUBLIC_HOLIDAYS = [
            "2026-01-01", // New Year's Day
            "2026-01-26", // Australia Day
            "2026-04-03", // Good Friday
            "2026-04-04", // Easter Saturday
            "2026-04-05", // Easter Sunday
            "2026-04-06", // Easter Monday
            "2026-04-27", // Anzac Day (Observed Monday)
            "2026-06-08", // King's Birthday
            "2026-10-05", // Labour Day
            "2026-12-25", // Christmas Day
            "2026-12-28", // Boxing Day (Observed Monday)
        ];
        
        // Firestore path helper for student details
        const getStudentDetailsDocRef = (uid) => doc(db, 'artifacts', appId, 'users', uid, 'studentDetails', 'info');

        // State variables (Note: 'startDate' key in Firestore holds the user's desired END date)
        let studentDetails = { name: '', number: '', startDate: '' }; 
        let calculatedSchedule = []; // Stores the final, calculated timetable data

        // Utility to show temporary, custom messages (instead of alert())
        const showMessage = (message, isError = false) => {
            const box = document.getElementById('message-box');
            box.innerHTML = `
                <div class="p-3 mb-2 rounded-lg text-sm font-semibold shadow-lg ${isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}">
                    ${message}
                </div>
            `;
            setTimeout(() => { box.innerHTML = ''; }, 5000);
        };

        // --- Date Calculation Helper (REVERSED & DYNAMIC LOGIC) ---

        /**
         * Converts a "X week(s)" string into an integer number of days.
         * @param {string} weeksStr - The duration string (e.g., "1 week", "2 weeks", "0 week").
         * @returns {number} The duration in days.
         */
        function getDaysFromWeeks(weeksStr) {
            const match = weeksStr.match(/(\d+)/);
            const weeks = match ? parseInt(match[1], 10) : 0;
            return weeks * 7;
        }
        
        /**
         * Checks if a date falls on a weekend (Saturday or Sunday).
         * @param {Date} date - The Date object to check.
         * @returns {boolean} True if it's a weekend, false otherwise.
         */
        function isWeekend(date) {
            const day = date.getDay();
            return day === 0 || day === 6; // Sunday (0) or Saturday (6)
        }

        /**
         * Checks if a date falls on a representative public holiday.
         * @param {Date} date - The Date object to check.
         * @returns {boolean} True if it's a holiday, false otherwise.
         */
        function isHoliday(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            
            return PUBLIC_HOLIDAYS.includes(dateStr);
        }

        /**
         * Finds the previous valid working day (Monday to Friday, non-holiday).
         * @param {Date} date - The calculated date.
         * @returns {Date} The previous valid working date.
         */
        function getPreviousValidDate(date) {
            const validDate = new Date(date.getTime()); // Work with a copy

            // Keep subtracting a day until it's a weekday and not a holiday
            while (isWeekend(validDate) || isHoliday(validDate)) {
                validDate.setDate(validDate.getDate() - 1);
            }
            return validDate;
        }
        
        /**
         * Finds the next valid working day (Monday to Friday, non-holiday).
         * @param {Date} date - The calculated date.
         * @returns {Date} The next valid working date.
         */
        function getNextValidDate(date) {
            const validDate = new Date(date.getTime()); // Work with a copy

            // Keep adding a day until it's a weekday and not a holiday
            while (isWeekend(validDate) || isHoliday(validDate)) {
                validDate.setDate(validDate.getDate() + 1);
            }
            return validDate;
        }


        /**
         * Subtracts a specified number of weeks (converted to days) from a base Date object, 
         * then adjusts the date to the previous available weekday. Used for backward scheduling.
         * @param {Date} baseDate - The Date object to start from (the next submission date).
         * @param {string} weeksStr - The duration string.
         * @returns {Date} The new Date object after subtracting the time and adjustment.
         */
        function subtractWeeksFromDate(baseDate, weeksStr) {
            const days = getDaysFromWeeks(weeksStr);
            
            // Start from the day *before* the submission date for the prior task
            const rawDate = new Date(baseDate.getTime());
            rawDate.setDate(rawDate.getDate() - 1); // Go back one day
            
            // Subtract the required weeks (in days)
            rawDate.setDate(rawDate.getDate() - days);
            
            // Find the nearest previous valid business day
            return getPreviousValidDate(rawDate);
        }

        /**
         * Formats a Date object to DD/MM/YYYY string.
         * @param {Date} dateObj - The Date object to format.
         * @returns {string} Formatted date (DD/MM/YYYY).
         */
        function formatDate(dateObj) {
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
            const year = dateObj.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // --- Firebase Functions ---
        
        async function loadStudentDetails() {
            if (!isSavingEnabled || !userId || !db) {
                // If saving is disabled, try to load from a dummy structure or proceed to render
                renderTimetable(UNIT_ASSESSMENT_DATA); 
                return;
            }

            try {
                const docSnap = await getDoc(getStudentDetailsDocRef(userId));
                if (docSnap.exists()) {
                    studentDetails = docSnap.data();
                    
                    const endDateInput = document.getElementById('course-end-date');
                    
                    document.getElementById('student-name').value = studentDetails.name || '';
                    document.getElementById('student-number').value = studentDetails.number || '';
                    
                    if (studentDetails.startDate) {
                        endDateInput.value = studentDetails.startDate; 
                    } else {
                        endDateInput.value = '';
                    }
                    
                } else {
                    console.log("No student details found. Using defaults/empty.");
                }
                // Always render the timetable based on stored details or defaults
                renderTimetable(UNIT_ASSESSMENT_DATA); 

            } catch (e) {
                console.error("Error loading student details:", e);
                showMessage("Failed to load student details.", true);
                renderTimetable(UNIT_ASSESSMENT_DATA); 
            }
        }

        async function handleSaveDetails(e) {
            e.preventDefault();
            
            const courseAnchorDate = document.getElementById('course-end-date').value.trim();
            
            if (!courseAnchorDate) {
                showMessage("Please select a Desired Course End Date.", true);
                return;
            }

            const newDetails = {
                name: document.getElementById('student-name').value.trim(),
                number: document.getElementById('student-number').value.trim(),
                startDate: courseAnchorDate, // Store the anchor date (End Date) in the 'startDate' field
            };
            
            studentDetails = newDetails;
            renderTimetable(UNIT_ASSESSMENT_DATA);
            
            if (!isSavingEnabled || !userId || !db) { 
                showMessage("Calculation complete. Cannot save data with dummy Firebase configuration.", true); 
                return;
            }
            
            try {
                await setDoc(getStudentDetailsDocRef(userId), newDetails, { merge: true });
                showMessage("Student details saved successfully!");
            } catch (e) {
                console.error("Error saving student details:", e);
                showMessage("Failed to save student details.", true);
            }
        }
        
        /**
         * Trigger the browser's print dialog.
         */
        function handlePrint() {
            window.print();
        }

        // --- Rendering Function (REVERSE & STRETCH LOGIC) ---

        function renderTimetable(data) {
            const container = document.getElementById('timetable-body');
            const calculatedStartDateEl = document.getElementById('display-start-date'); 
            const desiredEndDateEl = document.getElementById('display-end-date');
            const desiredEndDatePrintEl = document.getElementById('display-end-date-print');
            const stretchMessage = document.getElementById('stretch-message');
            const printInfoName = document.getElementById('print-info-name');
            const printInfoNumber = document.getElementById('print-info-number');

            if (!container) return;

            const courseAnchorDateStr = studentDetails.startDate; // This is the END date now
            let latestCalculatedStartDate = null; 
            let adjustedCourseEndDate = null;
            let scheduleIsStretched = false;

            // Reset header display and stretch message
            calculatedStartDateEl.textContent = 'N/A';
            desiredEndDateEl.textContent = 'N/A';
            desiredEndDatePrintEl.textContent = 'N/A';
            stretchMessage.classList.add('hidden');
            printInfoName.textContent = studentDetails.name || 'N/A';
            printInfoNumber.textContent = studentDetails.number || 'N/A';
            
            // Clear previous schedule
            calculatedSchedule = [];

            if (!courseAnchorDateStr) {
                container.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-red-500 font-semibold">Please enter a Desired Course End Date and click "Save Details & Calculate Dates" to generate the schedule.</td></tr>';
                return;
            }
            
            // 1. Initialize End Date and adjust it to the previous valid business day
            let currentSubmissionDate = new Date(courseAnchorDateStr);
            currentSubmissionDate.setHours(12, 0, 0, 0); 
            
            if (isNaN(currentSubmissionDate.getTime())) {
                container.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-red-500 font-semibold">Invalid Course End Date. Please correct the date input.</td></tr>';
                return;
            }

            // The final assessment must be submitted on or before the adjusted end date
            adjustedCourseEndDate = getPreviousValidDate(currentSubmissionDate);
            const endDateFormatted = formatDate(adjustedCourseEndDate);
            desiredEndDateEl.textContent = endDateFormatted;
            desiredEndDatePrintEl.textContent = endDateFormatted;

            // --- SCENARIO 1: BACKWARD CALCULATION (Default) ---
            
            let tempTimetable = [];
            
            // The first assessment's submission date is the adjusted course end date
            let rollingDateBackward = adjustedCourseEndDate;

            // Iterate BACKWARDS through the assessment data
            for (let i = data.length - 1; i >= 0; i--) {
                const item = data[i];

                // The calculated submission date for assessment 'i'
                const submissionDate = rollingDateBackward;
                
                if (i === 0) {
                    latestCalculatedStartDate = submissionDate; 
                }

                tempTimetable.push({
                    ...item,
                    CalculatedDate: submissionDate
                });

                // Calculate the submission date for the * previous* assessment, starting from the day *before* the current submission date minus the duration
                rollingDateBackward = subtractWeeksFromDate(submissionDate, item.Weeks);
            }

            tempTimetable.reverse();
            calculatedSchedule = tempTimetable; // Store the calculated schedule

            // 2. CHECK: If the calculated start date is in the past, switch to Dynamic Apportionment
            // Check if the calculated ideal start date is BEFORE today's date (at noon)
            if (latestCalculatedStartDate.getTime() < TODAY.getTime()) {
                
                // --- SCENARIO 2: STRETCHING REQUIRED (Proportional Apportionment) ---
                
                // a) Calculate Total Required Effort (in calendar days, based on 'Weeks' field)
                let totalRequiredCalendarDays = 0;
                UNIT_ASSESSMENT_DATA.forEach(item => {
                    totalRequiredCalendarDays += getDaysFromWeeks(item.Weeks); 
                });
                
                // b) Determine Available Calendar Days (simple difference from Today to End Date)
                const msInDay = 24 * 60 * 60 * 1000;
                
                // Start from the next valid business day on or after today
                const actualStartDate = getNextValidDate(TODAY);
                
                // We use adjustedCourseEndDate (already adjusted to a business day)
                let timeDifferenceMs = adjustedCourseEndDate.getTime() - actualStartDate.getTime();
                
                // Only stretch if there is a meaningful duration of days between today and the end date
                if (timeDifferenceMs > 0 && totalRequiredCalendarDays > 0) {
                    scheduleIsStretched = true;
                    // Total available time in days (plus 1 to include the last day)
                    const totalAvailableCalendarDays = Math.floor(timeDifferenceMs / msInDay) + 1; 

                    // c) Calculate the Day Multiplier (Stretching factor)
                    let dayMultiplier = totalAvailableCalendarDays / totalRequiredCalendarDays;
                    
                    // d) Recalculate Forward
                    // Start rolling date calculation from the actual calculated start date (today or next business day)
                    let rollingDateForward = actualStartDate;
                    let stretchedTimetable = [];
                    let totalDaysAdded = 0;

                    UNIT_ASSESSMENT_DATA.forEach((item, index) => {
                        const requiredDays = getDaysFromWeeks(item.Weeks);
                        let daysToAdd = 0;
                        
                        // APPORTIONMENT: Apply multiplier proportionally to the required time
                        if (requiredDays > 0) {
                            // Calculate days, rounding up
                            daysToAdd = Math.ceil(requiredDays * dayMultiplier);
                        } 
                        
                        // Start calculating the new date from the day *after* the previous submission
                        const currentTaskStartDate = new Date(rollingDateForward.getTime());
                        
                        // If it's the very first task, the start date is the actual start date
                        if (index !== 0) {
                            currentTaskStartDate.setDate(currentTaskStartDate.getDate() + 1);
                        }

                        // Add the calculated stretched days to find the raw submission date
                        const rawSubmissionDate = new Date(currentTaskStartDate.getTime());
                        rawSubmissionDate.setDate(rawSubmissionDate.getDate() + daysToAdd);
                        
                        // Adjust the raw submission date to the previous valid business day
                        let submissionDate = getPreviousValidDate(rawSubmissionDate);
                        
                        // If this is the final assessment, force it to the adjustedCourseEndDate
                        if (index === UNIT_ASSESSMENT_DATA.length - 1) {
                            submissionDate = adjustedCourseEndDate;
                        }

                        // The next rolling start date is based on the submission date of the current task
                        rollingDateForward = submissionDate; 
                        
                        stretchedTimetable.push({
                            ...item,
                            CalculatedDate: submissionDate
                        });
                    });

                    // Use the stretched timetable for rendering
                    calculatedSchedule = stretchedTimetable;
                    latestCalculatedStartDate = actualStartDate; // The new start date is the first valid day on or after today

                }
            }


            // 3. Render the final HTML table
            let html = '';
            let currentUnitCode = null;

            calculatedSchedule.forEach((item) => {
                
                const dateDisplay = formatDate(item.CalculatedDate);

                // Start of a new unit group header row
                if (item.UnitCode !== currentUnitCode) {
                    currentUnitCode = item.UnitCode;
                    html += `
                        <tr class="bg-gray-100 font-bold text-dapa-primary">
                            <td colspan="4" class="px-4 py-2 border-t-4 border-dapa-primary">
                                ${item.UnitCode === 'INTRO' ? item.UnitDescription : item.UnitCode + ' - ' + item.UnitDescription}
                            </td>
                        </tr>
                    `;
                }

                // Assessment Row
                html += `
                    <tr class="timetable-row border-b border-gray-200 bg-white" data-unit-code="${item.UnitCode}" data-assessment-name="${item.AssessmentName}">
                        <!-- Unit Code (w-1/12) -->
                        <td class="px-4 py-3 text-sm font-medium text-gray-900 w-1/12">${item.UnitCode === 'INTRO' ? '' : item.UnitCode}</td>
                        <!-- Assessment (w-1/12) -->
                        <td class="px-4 py-3 text-sm text-gray-700 w-1/12">${item.AssessmentName}</td>
                        <!-- Assessment Description (w-6/12 - Adjusted width) -->
                        <td class="px-4 py-3 text-sm text-gray-700 max-w-md w-6/12">${item.AssessmentDescription}</td>
                        <!-- Latest Submission Date (w-4/12 - Adjusted width) -->
                        <td class="px-4 py-3 text-center text-sm text-dapa-primary font-bold w-4/12">
                            ${dateDisplay}
                        </td>
                    </tr>
                `;
            });

            container.innerHTML = html;
            
            // 4. Update Header and Message
            if (latestCalculatedStartDate) {
                 calculatedStartDateEl.textContent = formatDate(latestCalculatedStartDate);
                 document.getElementById('print-info-start-date').textContent = formatDate(latestCalculatedStartDate);
            }
            
            if (scheduleIsStretched) {
                stretchMessage.textContent = `⚠️ Warning: The ideal start date was in the past. The schedule has been dynamically stretched from today (${formatDate(latestCalculatedStartDate)}) to meet your desired end date. **Time is apportioned proportionally to the Weeks required for each task.**`;
                stretchMessage.classList.remove('hidden');
                document.getElementById('print-info-stretched').textContent = 'YES (Schedule stretched due to past ideal start date)';
            } else {
                document.getElementById('print-info-stretched').textContent = 'NO';
            }
        }


        // --- Initialization ---

        function initFirebaseAndAuth() {
            setLogLevel('debug'); // Enable detailed Firebase logging
            
            if (firebaseConfig.apiKey === "DUMMY_API_KEY") {
                console.warn("Using DUMMY Firebase configuration. Data will not be saved or loaded.");
                showMessage("Running with DUMMY config. Data saving/loading is disabled.", true);
                isSavingEnabled = false;
                userId = crypto.randomUUID(); 
                document.getElementById('display-user-id').textContent = userId + ' (Local/Dummy)';
                renderTimetable(UNIT_ASSESSMENT_DATA); 
                
                // Proceed to attach event listeners even without full Firebase
                attachEventListeners();
                return;
            }
            
            // If configuration is valid (not dummy), proceed with Firebase init
            isSavingEnabled = true;

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                const signInProcedure = async () => {
                    if (initialAuthToken) {
                        return signInWithCustomToken(auth, initialAuthToken)
                            .catch(error => {
                                console.error("Custom token sign-in failed. Falling back to anonymous.", error);
                                return signInAnonymously(auth);
                            });
                    } else {
                        return signInAnonymously(auth).catch(error => {
                            console.error("Anonymous sign-in failed.", error);
                        });
                    }
                };

                // Auth state listener: runs when auth state changes (sign-in/out)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated with userId:", userId);
                        document.getElementById('display-user-id').textContent = userId;
                        // Once authenticated, load data
                        loadStudentDetails();
                    } else {
                        userId = null;
                        console.log("No user signed in. Waiting for sign-in.");
                        userId = crypto.randomUUID(); 
                        document.getElementById('display-user-id').textContent = userId + ' (Anonymous)';
                        renderTimetable(UNIT_ASSESSMENT_DATA); 
                    }
                });
                
                // Execute sign-in attempt
                signInProcedure();
                
                // Attach event listeners
                attachEventListeners();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("Firebase setup error. Check console.", true);
                renderTimetable(UNIT_ASSESSMENT_DATA); 
            }
        }
        
        function attachEventListeners() {
            const form = document.getElementById('student-details-form');
            if (form) {
                form.addEventListener('submit', handleSaveDetails);
            } else {
                console.error("Form element 'student-details-form' not found.");
            }
            
            const printBtn = document.getElementById('print-button');
            if (printBtn) {
                printBtn.addEventListener('click', handlePrint);
            } else {
                console.error("Print button 'print-button' not found.");
            }
        }

        // Start the application flow on window load
        window.onload = initFirebaseAndAuth;

    </script>
</head>
<body class="bg-dapa-background p-4 sm:p-8">

    <!-- Message Box for feedback (instead of alerts) -->
    <div id="message-box"></div>

    <div class="timetable-container">
        
        <!-- Header Section (Hidden during Print) -->
        <div class="header-section mb-6">
            <h1 class="text-3xl font-extrabold text-dapa-primary mb-1">HLT35021 DAPA Assessment Timetable</h1>
            
            <!-- DATE DISPLAY BLOCK (LABELS SWAPPED) -->
            <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm text-gray-700 font-semibold mb-3">
                <p>Calculated Start Date: <span id="display-start-date" class="text-green-600 font-extrabold">N/A</span></p>
                <p>Desired Course End Date: <span id="display-end-date" class="text-red-500 font-extrabold">N/A</span></p>
            </div>
            <!-- END DATE DISPLAY BLOCK -->

            <p class="text-gray-600 mb-2">Review your estimated submission schedule below, calculated backwards from your desired end date.</p>
            
            <!-- Dynamic Stretch Message -->
            <p id="stretch-message" class="text-sm text-yellow-800 italic border-l-4 border-yellow-500 pl-3 py-1 bg-yellow-100 rounded-md hidden mb-2">
                <!-- Content inserted by JS if stretching is applied -->
            </p>
            
            <p class="text-sm text-gray-500 italic border-l-4 border-gray-300 pl-3 py-1 bg-white rounded-md">
                Submission dates automatically adjust to the **previous** business day if they fall on a weekend or a public holiday.
            </p>

            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mt-4">
                <!-- Student Details Form -->
                <form id="student-details-form" class="w-full grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-1">
                        <label for="student-name" class="block text-xs font-semibold uppercase text-gray-500 mb-1">Student Name</label>
                        <input type="text" id="student-name" class="w-full p-2 border border-gray-300 rounded-md focus:ring-dapa-primary focus:border-dapa-primary transition" placeholder="Jane Doe">
                    </div>
                    <div class="md:col-span-1">
                        <label for="student-number" class="block text-xs font-semibold uppercase text-gray-500 mb-1">Student Number</label>
                        <input type="text" id="student-number" class="w-full p-2 border border-gray-300 rounded-md focus:ring-dapa-primary focus:border-dapa-primary transition" placeholder="S1234567">
                    </div>
                    <!-- INPUT CHANGED TO END DATE -->
                    <div class="md:col-span-1">
                        <label for="course-end-date" class="block text-xs font-semibold uppercase text-gray-500 mb-1">Desired Course End Date</label>
                        <input type="date" id="course-end-date" 
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring-dapa-primary focus:border-dapa-primary transition">
                    </div>
                    <!-- Buttons Container -->
                    <div id="print-button-container" class="md:col-span-1 pt-2 flex space-x-2 items-end">
                        <button type="submit" class="bg-dapa-primary text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-dapa-accent-hover transition duration-300 flex-1">
                            Save & Calculate
                        </button>
                        <button type="button" id="print-button" class="bg-gray-500 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-gray-600 transition duration-300 flex-1">
                            Print (PDF)
                        </button>
                    </div>
                    <!-- END Buttons Container -->
                </form>

            </div>
        </div>
        
        <!-- Print-Specific Header Info (Hidden on Screen) -->
        <div id="print-info" class="hidden">
            <h1 class="text-xl font-bold text-gray-800 mb-4">HLT35021 Assessment Timetable</h1>
            <div class="grid grid-cols-2 gap-y-1 text-sm text-gray-600">
                <p><span class="font-semibold text-dapa-primary">Student:</span> <span id="print-info-name">N/A</span></p>
                <p><span class="font-semibold text-dapa-primary">Student ID:</span> <span id="print-info-number">N/A</span></p>
                <p><span class="font-semibold text-dapa-primary">Calculated Start:</span> <span id="print-info-start-date">N/A</span></p>
                <p><span class="font-semibold text-dapa-primary">Desired End:</span> <span id="display-end-date-print">N/A</span></p>
                <p class="col-span-2"><span class="font-semibold text-dapa-primary">Schedule Stretched:</span> <span id="print-info-stretched">NO</span></p>
            </div>
            <hr class="mt-4 border-gray-300">
        </div>
        <!-- END Print-Specific Header Info -->

        <!-- Timetable Table -->
        <div class="shadow-xl rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-dapa-primary text-white">
                    <tr>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider w-1/12">Unit Code</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider w-1/12">Assessment</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider w-6/12">Assessment Description</th>
                        <!-- COLUMN NAME CHANGE to reflect reverse logic -->
                        <th scope="col" class="px-4 py-3 text-center text-xs font-bold uppercase tracking-wider w-4/12">Latest Submission Date</th>
                    </tr>
                </thead>
                <tbody id="timetable-body" class="bg-white divide-y divide-gray-200">
                    <!-- Timetable rows will be rendered here by JavaScript -->
                    <tr>
                        <td colspan="4" class="p-8 text-center text-gray-500">Loading Timetable Data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <p class="text-center text-xs text-gray-400 mt-4 no-print">
            User ID: <span id="display-user-id">Loading...</span>
        </p>

    </div>
</body>
</html>
